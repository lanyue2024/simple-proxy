daemon off;
worker_processes  1;

events {
    worker_connections 2000;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    keepalive_timeout 30s;
    access_log off;
    resolver 223.5.5.5 180.76.76.76 ipv6=off;
    resolver_timeout 5s;

    map $connect_host $conn_addr {
        hostnames;
        default "";

        ### AAA 修改IP但不改SNI
        #.example.com 127.0.0.1:9443;

        ###### 改SNI
        ### BBB 发送SNI
        .duckduckgo.com 127.0.0.1:9881;
        hub.docker.com 127.0.0.1:9881;
        huggingface.co 127.0.0.1:9881;
        cdn-avatars.huggingface.co 127.0.0.1:9881;
        .google.com 127.0.0.1:9881;
        *.gstatic.com 127.0.0.1:9881;
        *.googleapis.com 127.0.0.1:9881;
        .youtube.com 127.0.0.1:9881;
        *.ytimg.com 127.0.0.1:9881;
        *.ggpht.com 127.0.0.1:9881;

        ### CCC 不发送SNI
        production.cloudflare.docker.com 127.0.0.1:9882;
    }

    server {
        listen 9080;
        # https://github.com/chobits/ngx_http_proxy_connect_module
        proxy_connect;
        proxy_connect_allow all;
        proxy_connect_connect_timeout 10s;
        proxy_connect_data_timeout 30s;
        proxy_connect_address $conn_addr;

        location / {
            proxy_pass http://$host;
            proxy_set_header Host $host;
            proxy_pass_header Server;
        }
    }
}

stream {
    resolver 223.5.5.5 180.76.76.76 ipv6=off;
    resolver_timeout 5s;

    map $ssl_preread_server_name $proxy_conn_addr {
        hostnames;
        default $ssl_preread_server_name:443;

        # AAA 修改IP但不改SNI
        #.example.com 20.0.0.1:443;
    }

    map $ssl_server_name $ssl_conn_addr {
        hostnames;
        default $ssl_server_name:443;

        ####### 设置IP
        # BBB
        .duckduckgo.com ddg.co:443;
        hub.docker.com docker.io:443;
        huggingface.co d3tt2suyqs9zqv.cloudfront.net:443;
        cdn-avatars.huggingface.co d3tt2suyqs9zqv.cloudfront.net:443;
        .google.com 126.123.221.28:10689;
        *.gstatic.com 126.123.221.28:10689;
        *.googleapis.com 126.123.221.28:10689;
        .youtube.com 126.123.221.28:10689;
        *.ytimg.com 126.123.221.28:10689;
        *.ggpht.com 126.123.221.28:10689;

        # CCC
        production.cloudflare.docker.com 104.16.99.215:443;
    }

    map $ssl_server_name $sni {
        hostnames;
        default $ssl_server_name;

        ###### 设置SNI
        # BBB
        .duckduckgo.com ddg.co;
        hub.docker.com docker.io;
        huggingface.co d3tt2suyqs9zqv.cloudfront.net;
        cdn-avatars.huggingface.co d3tt2suyqs9zqv.cloudfront.net;
        .google.com fonts.gstatic.com;
        *.gstatic.com fonts.gstatic.com;
        *.googleapis.com fonts.gstatic.com;
        .youtube.com fonts.gstatic.com;
        *.ytimg.com fonts.gstatic.com;
        *.ggpht.com fonts.gstatic.com;

        # CCC
        # 默认使用default的值
    }


    server {
        listen      9443;
        proxy_pass  $proxy_conn_addr;
        ssl_preread on;
    }

    server {
        listen 127.0.0.1:9881 ssl;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_certificate     allname.crt;
        ssl_certificate_key allname.key;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;

        proxy_ssl on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_pass $ssl_conn_addr;

        proxy_ssl_server_name on;
        proxy_ssl_name $sni;
        proxy_ssl_verify on;
        # https://curl.se/docs/caextract.html
        proxy_ssl_trusted_certificate cacert.pem;
    }

    server {
        listen 127.0.0.1:9882 ssl;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_certificate     allname.crt;
        ssl_certificate_key allname.key;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;

        proxy_ssl on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_pass $ssl_conn_addr;

        proxy_ssl_server_name off; # 不发送SNI
        proxy_ssl_name $sni; # 用于验证服务器SSL
        proxy_ssl_verify on;
        proxy_ssl_trusted_certificate cacert.pem;
    }
}
