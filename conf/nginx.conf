daemon off;
worker_processes  1;

events {
    worker_connections 2000;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    keepalive_timeout 30s;
    access_log off;
    resolver 223.5.5.5 180.76.76.76 ipv6=off;
    resolver_timeout 5s;

    # cloudflare
    map $http_host $pages_host {
        default shut7234.pages.dev;
    }

    map $connect_host $conn_addr {
        hostnames;
        default "";

        ### BBB 发送SNI
        # huggingface
        huggingface.co 127.0.0.1:9081;
        cdn-avatars.huggingface.co 127.0.0.1:9081;

        # google
        google.com 127.0.0.1:9081;
        *.google.com 127.0.0.1:9081;
        *.gstatic.com 127.0.0.1:9081;
        *.googleapis.com 127.0.0.1:9081;
        *.googleusercontent.com 127.0.0.1:9081;
        youtube.com 127.0.0.1:9081;
        *.youtube.com 127.0.0.1:9081;
        *.ytimg.com 127.0.0.1:9081;
        *.ggpht.com 127.0.0.1:9081;

        # spotify
        www.spotify.com 127.0.0.1:9081;
        spclient.wg.spotify.com 127.0.0.1:9081;


        ### CCC 不发送SNI
        # duckduckgo
        duckduckgo.com 127.0.0.1:9082;
        *.duckduckgo.com 127.0.0.1:9082;

        # pixiv
        pixiv.net 127.0.0.1:9082;
        *.pixiv.net 127.0.0.1:9082;
        *.pximg.net 127.0.0.1:9082;

        # docker
        hub.docker.com 127.0.0.1:9082;
        production.cloudflare.docker.com 127.0.0.1:9082;

        # discord
        discord.com 127.0.0.1:9082;
        *.discord.com 127.0.0.1:9082;
        discord.gg 127.0.0.1:9082;
        *.discord.gg 127.0.0.1:9082;
        *.discordapp.com 127.0.0.1:9082;

        # spotify
        open.spotify.com 127.0.0.1:9082;


        ### DDD cloudflare 中转
        *.googlevideo.com 127.0.0.1:9083;
    }

    server {
        listen 9080;
        # https://github.com/chobits/ngx_http_proxy_connect_module
        proxy_connect;
        proxy_connect_allow all;
        proxy_connect_connect_timeout 10s;
        proxy_connect_data_timeout 300s;
        proxy_connect_address $conn_addr;

        location / {
            proxy_pass http://$host;
            proxy_set_header Host $host;
            proxy_pass_header Server;
        }
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      "";
    }
    upstream cloudflare {
        server 104.18.8.122:443;
        keepalive 8;
    }
    server {
        listen              127.0.0.1:9083 ssl;
        server_name         localhost;
        ssl_certificate     allname.crt;
        ssl_certificate_key allname.key;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_session_cache   shared:httpSSL:10m;
        ssl_session_timeout 10m;

        location / {
            proxy_pass https://cloudflare;
            proxy_set_header Host $pages_host;
            proxy_ssl_name $pages_host;
            proxy_ssl_server_name on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_verify on;
            proxy_ssl_trusted_certificate cacert.pem;
            proxy_set_header simplehost $http_host;
            proxy_pass_header Server;
            proxy_connect_timeout 10s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
}

stream {
    resolver 223.5.5.5 180.76.76.76 ipv6=off;
    resolver_timeout 5s;

    map $ssl_server_name $ssl_conn_addr {
        hostnames;
        default $ssl_server_name:443;

        ### 设置IP
        # BBB
        huggingface.co d3tt2suyqs9zqv.cloudfront.net:443;
        cdn-avatars.huggingface.co d3tt2suyqs9zqv.cloudfront.net:443;
        google.com 126.123.221.28:10689;
        *.google.com 126.123.221.28:10689;
        *.gstatic.com 126.123.221.28:10689;
        *.googleapis.com 126.123.221.28:10689;
        *.googleusercontent.com 126.123.221.28:10689;
        youtube.com 126.123.221.28:10689;
        *.youtube.com 126.123.221.28:10689;
        *.ytimg.com 126.123.221.28:10689;
        *.ggpht.com 126.123.221.28:10689;
        www.spotify.com 199.193.127.138:33932;
        spclient.wg.spotify.com 199.193.127.138:33932;

        # CCC
        duckduckgo.com 91.108.241.204:443; # ddg.co
        *.duckduckgo.com 91.108.241.204:443;
        hub.docker.com docker.io:443;
        production.cloudflare.docker.com 104.16.99.215:443;
        pixiv.net 210.140.92.182:443; # cdn-origin.pixiv.net
        *.pixiv.net 210.140.92.182:443;
        *.pximg.net s.pximg.net:443;
        discord.com 162.159.138.232:443;
        *.discord.com 162.159.138.232:443;
        discord.gg 162.159.130.234:443;
        *.discord.gg 162.159.130.234:443;
        *.discordapp.com 162.159.129.233:443;
        open.spotify.com 74.48.92.253:443; # fastly.com
    }

    map $ssl_server_name $sni {
        hostnames;
        default $ssl_server_name;

        ### 设置SNI
        # BBB 发送SNI及验证服务器SSL
        huggingface.co d3tt2suyqs9zqv.cloudfront.net;
        cdn-avatars.huggingface.co d3tt2suyqs9zqv.cloudfront.net;
        google.com fonts.gstatic.com;
        *.google.com fonts.gstatic.com;
        *.gstatic.com fonts.gstatic.com;
        *.googleapis.com fonts.gstatic.com;
        *.googleusercontent.com fonts.gstatic.com;
        youtube.com fonts.gstatic.com;
        *.youtube.com fonts.gstatic.com;
        *.ytimg.com fonts.gstatic.com;
        *.ggpht.com fonts.gstatic.com;


        # CCC 不发送SNI，只用于验证
        open.spotify.com fastly.com;
    }


    server {
        listen 127.0.0.1:9081 ssl;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_certificate     allname.crt;
        ssl_certificate_key allname.key;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;

        proxy_ssl on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_pass $ssl_conn_addr;
        proxy_connect_timeout 10s;
        proxy_timeout 300s;

        proxy_ssl_server_name on;
        proxy_ssl_name $sni;
        proxy_ssl_verify on;
        # https://curl.se/docs/caextract.html
        proxy_ssl_trusted_certificate cacert.pem;
    }

    server {
        listen 127.0.0.1:9082 ssl;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_certificate     allname.crt;
        ssl_certificate_key allname.key;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;

        proxy_ssl on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_pass $ssl_conn_addr;
        proxy_connect_timeout 10s;
        proxy_timeout 300s;

        proxy_ssl_server_name off; # 不发送SNI
        proxy_ssl_name $sni; # 用于验证服务器SSL
        proxy_ssl_verify on;
        proxy_ssl_trusted_certificate cacert.pem;
    }
}
